myApp.controller("partner",["$scope","$http","$location","$timeout","NgTableParams",function(n,t,i,r,u){var f,e;window.hub.stop();f=this;n.isAdd=!0;n.allowUpload=!1;n.partner={};n.kw="";n.paginationConf={currentPage:1,itemsPerPage:10,pagesLength:25,perPageOptions:[1,5,10,15,20,30,40,50,100,200],rememberPerPage:"perPageItems",onChange:function(){f.GetPageData(n.paginationConf.currentPage,n.paginationConf.itemsPerPage)}};this.GetPageData=function(i,r){t.post("/partner/getpagedata",{page:i,size:r,kw:n.kw}).then(function(t){n.paginationConf.totalItems=t.data.TotalCount;$("div[ng-table-pagination]").remove();f.tableParams=new u({count:5e4},{filterDelay:0,dataset:t.data.Data});f.data=t.data.Data})};$(".ui.dropdown.types").dropdown({onChange:function(t){n.partner.Types=t}});n.getCategory=function(){t.post("/category/getcategories",null).then(function(t){var i=t.data;i.Success?(n.cat=i.Data,$(".ui.dropdown.category").dropdown({onChange:function(t){n.partner.CategoryIds=t},message:{maxSelections:"最多选择 {maxCount} 项",noResults:"无搜索结果！"}})):window.notie.alert({type:3,text:"获取文章分类失败！",time:4})})};n.getCategory();n.remove=function(t){layer.closeAll();swal({title:"确定移除这条广告吗？",text:t.Title,type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"确定",cancelButtonText:"取消"}).then(function(i){i&&n.request("/partner/delete/"+t.Id,null,function(t){swal(t.Message,null,"success");f.GetPageData(n.paginationConf.currentPage,n.paginationConf.itemsPerPage)})}).catch(swal.noop)};n.add=function(){n.partner={ExpireTime:"2099-12-31"};n.isAdd=!0;n.allowUpload=!1;layer.open({type:1,zIndex:20,title:"添加广告推广",area:(window.screen.width>650?650:window.screen.width)+"px",content:$("#edit"),cancel:function(){return setTimeout(function(){$("#edit").css("display","none")},500),!0}})};n.edit=function(t){n.partner=angular.copy(t);n.partner.ExpireTime=n.partner.ExpireTime==null?"2099-12-31":n.partner.ExpireTime;n.isAdd=!1;n.allowUpload=!1;layer.closeAll();r(function(){$(".ui.dropdown.category").dropdown("clear");$(".ui.dropdown.types").dropdown("clear");$(".ui.dropdown.category").dropdown("set selected",(t.CategoryIds+"").split(","));$(".ui.dropdown.types").dropdown("set selected",t.Types.split(","))},10);layer.open({type:1,zIndex:20,title:"保存广告",area:(window.screen.width>650?650:window.screen.width)+"px",content:$("#edit"),cancel:function(){return setTimeout(function(){$("#edit").css("display","none")},500),!0}})};n.closeAll=function(){layer.closeAll();setTimeout(function(){$("#edit").css("display","none")},500)};n.submit=function(t){n.isAdd&&(t.Id=0);n.request("/partner/save",t,function(t){n.closeAll();window.notie.alert({type:1,text:t.Message,time:4});f.GetPageData(n.paginationConf.currentPage,n.paginationConf.itemsPerPage);n.partner.ImageUrl="";n.partner.Description=""})};n.uploadImage=function(t){$("#uploadform").ajaxSubmit({url:"/Upload",type:"post",success:function(i){document.getElementById("uploadform").reset();n.$apply(function(){n.partner[t]=i.Data;layer.close(layer.index)})}})};n.upload=function(t){n.imgField=t;layer.open({type:1,zIndex:20,title:"上传图片",area:[(window.screen.width>300?300:window.screen.width)+"px","80px"],content:$("#img-upload"),cancel:function(){return!0}})};n.search=function(t){e&&r.cancel(e);e=r(function(){n.kw=t;f.GetPageData(n.paginationConf.currentPage,n.paginationConf.itemsPerPage);e=null},500)};n.changeState=function(t){n.request("/partner/ChangeState/"+t.Id,null,function(n){window.notie.alert({type:1,text:n.Message,time:4})})};n.detail=function(t){n.partner=angular.copy(t);layer.closeAll();$(".ui.dropdown.types").dropdown("clear");$(".ui.dropdown.types").dropdown("set selected",t.Types.split(","));layer.open({type:1,zIndex:20,offset:"50px",title:t.Title,area:(window.screen.width>850?850:window.screen.width)+"px",content:$("#detail"),cancel:function(){return!0}})};jeDate("#timespan",{isinitVal:!0,festival:!0,isTime:!0,ishmsVal:!0,format:"YYYY-MM-DD hh:mm:ss",minDate:(new Date).Format("yyyy-MM-dd 00:00:00"),maxDate:"2099-12-31 23:59:59",donefun:function(t){n.partner.ExpireTime=t.val}})}]);